<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>SD · Developer</title>
<link rel="stylesheet" href="style.css">

<style>
body{
  display:flex;
  height:100vh;
  margin:0;
  background:#0f172a;
  color:#e5e7eb;
  font-family:system-ui,sans-serif;
  overflow:hidden;
}

/* ===== Left ===== */
#list{
  width:240px;
  height:100vh;
  border-right:1px solid #334155;
  overflow-y:auto;
}

.list-header{
  position:sticky;
  top:0;
  z-index:10;
  background:#0f172a;
  padding:8px 0;
  border-bottom:1px solid #334155;
}

#devSearch{
  width:82%;
  margin:0 8px 6px;
  padding:10px;
  border-radius:12px;
  border:none;
  background:#020617;
  color:#e5e7eb;
}

#list button{
  width:90%;
  margin:0 8px 6px;
  padding:8px 10px;
  border-radius:12px;
  border:none;
  background:#1e293b;
  color:#e5e7eb;
  cursor:pointer;
}

#list button.active{background:#2563eb;}
#list button.dirty{background:#7c2d12;position:relative;}
#list button.dirty::after{
  content:"";
  width:8px;height:8px;
  background:#fb923c;
  border-radius:50%;
  position:absolute;
  right:10px;top:50%;
  transform:translateY(-50%);
}

/* ===== Editor ===== */
#editor{
  flex:1;
  max-width:920px;
  padding:24px 30px;
  margin:0 auto;
  overflow-y:auto;
}

#title.dirty::after{content:" *";color:#fb923c;}

label{
  margin-top:14px;
  display:block;
  font-size:13px;
  color:#94a3b8;
}

input{
  width:100%;
  max-width:760px;
  margin-top:6px;
  padding:10px;
  border-radius:12px;
  border:1px solid #334155;
  background:#020617;
  color:#e5e7eb;
}

.rich{
  max-width:760px;
  min-height:90px;
  margin-top:6px;
  padding:10px;
  border-radius:12px;
  border:1px solid #334155;
  background:#020617;
  color:#e5e7eb;
  white-space:pre-wrap;
}

.rich b{font-weight:600;}
.rich i{font-style:italic;}

/* ===== Tags ===== */
#tagSelect{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
.tag-btn{
  padding:6px 12px;
  border-radius:999px;
  font-size:13px;
  background:#1e293b;
  cursor:pointer;
}
.tag-btn.active{background:#2563eb}

/* ===== Dropdown / Chips ===== */
.dropdown{
  max-width:760px;
  background:#020617;
  border:1px solid #334155;
  border-radius:12px;
  margin-top:4px;
  display:none;
}
.dropdown div{padding:8px 12px;cursor:pointer;}
.dropdown div:hover{background:#1e293b;}

.chips{
  max-width:760px;
  margin-top:6px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.chip{
  padding:6px 10px;
  border-radius:999px;
  background:#1e293b;
  font-size:13px;
  cursor:pointer;
}
.chip:hover{background:#7c2d12}

/* ===== Buttons ===== */
.actions{margin-top:20px;display:flex;gap:10px}
.btn{padding:10px 16px;border-radius:12px;border:none;cursor:pointer}
.btn.primary{background:#2563eb;color:#fff}
.btn.danger{background:#dc2626;color:#fff}
.btn.ghost{background:#1e293b;color:#e5e7eb}
#list button:disabled{
  opacity:.3;
  cursor:not-allowed;
}

/* ===== Toast ===== */
#toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%) translateY(20px);
  background:#2563eb;
  color:#fff;
  padding:10px 18px;
  border-radius:999px;
  opacity:0;
  transition:.25s;
}
#toast.show{opacity:1;transform:translateX(-50%)}
/* 每一行 */
.list-row{
  display:flex;
  align-items:center;
  gap:4px;
  margin:0 8px 6px;
}

/* 排序按钮：小 + 等宽 */
.sort-btn{
  width:28px;
  height:28px;
  padding:0;
  border-radius:8px;
  border:none;
  background:#1e293b;
  color:#e5e7eb;
  cursor:pointer;
  font-size:14px;
}

.sort-btn:disabled{
  opacity:.3;
  cursor:not-allowed;
}

/* 单词按钮：占满剩余空间 */
.word-btn{
  flex:1;
  padding:8px 10px;
  border-radius:12px;
  border:none;
  background:#1e293b;
  color:#e5e7eb;
  cursor:pointer;
  text-align:left;
}

.word-btn.active{
  background:#2563eb;
}
.sort-btn{
  opacity:0;
}
.sort-mode .sort-btn{
  opacity:1;
}

</style>
</head>

<body>

<div id="list">
  <div class="list-header">
    <input id="devSearch" placeholder="搜索词条…">
    <button onclick="newWord()">新增词条</button>
    <button id="sortToggle">排序模式：关</button>
  </div>
  <div id="wordList"></div>
</div>

<div id="editor">
  <h2 id="title">未选择词条</h2>

  <label>英文 / en</label><input id="en">
  <label>中文 / cn</label><input id="cn">

  <label>英文解释 / enUsage</label>
  <div id="enUsage" class="rich" contenteditable="true"></div>

  <label>中文解释 / usage</label>
  <div id="usage" class="rich" contenteditable="true"></div>

  <label>学科标签 / tag</label>
  <div id="tagSelect"></div>

  <label>公式 / formula</label><input id="formula">
  <label>分类 / category</label><input id="category">

  <label>相似词 / similar</label>
  <input id="similarInput" placeholder="选择或输入">
  <div id="similarList" class="dropdown"></div>
  <div id="similarChips" class="chips"></div>

  <label>分类 / classification</label>
  <input id="classInput" placeholder="搜索已有词条">
  <div id="classList" class="dropdown"></div>
  <div id="classChips" class="chips"></div>

  <label>例子 / example</label><input id="example">
  <label>最后修改 / updated</label><input id="updated" disabled>

  <div class="actions">
    <button class="btn primary" onclick="save()">保存</button>
    <button class="btn danger" onclick="remove()">删除</button>
    <button class="btn ghost" onclick="exportData()">导出</button>
  </div>
</div>

<div id="toast">已保存 ✔</div>

<script src="data.js"></script>
<script>
const SUBJECT_TAGS=["Physics","Math","Chemistry","Biology","Computer"];
const row = document.createElement("div");
row.style.display = "flex";
row.style.alignItems = "center";
row.style.gap = "4px";
row.style.margin = "0 8px 6px";

let currentIndex=null,isDirty=false;
let selectedTags=[],similarSelected=[],classificationSelected=[];
let snapshot="";
let sortMode = false;

/* ===== util ===== */
function getFormState(){
  return JSON.stringify({
    en:en.value,cn:cn.value,
    enUsage:enUsage.innerHTML,
    usage:usage.innerHTML,
    formula:formula.value,
    category:category.value,
    similar:[...similarSelected],
    classification:[...classificationSelected],
    example:example.value,
    tags:[...selectedTags]
  });
}

function markDirty(){
  if(currentIndex===null)return;
  isDirty=true;
  title.classList.add("dirty");
  document.querySelectorAll("#wordList .word-btn")[currentIndex]?.classList.add("dirty");
}

function showToast(){
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),1500);
}

/* ===== dirty listeners ===== */
document.querySelectorAll("input").forEach(el=>el.addEventListener("input",markDirty));
document.querySelectorAll(".rich").forEach(el=>el.addEventListener("input",markDirty));

/* ===== tag ===== */
function renderTagSelector(){
  tagSelect.innerHTML="";
  SUBJECT_TAGS.forEach(t=>{
    const b=document.createElement("div");
    b.className="tag-btn"+(selectedTags.includes(t)?" active":"");
    b.textContent=t;
    b.onclick=()=>{
      selectedTags.includes(t)
        ?selectedTags=selectedTags.filter(x=>x!==t)
        :selectedTags.push(t);
      renderTagSelector();markDirty();
    };
    tagSelect.appendChild(b);
  });
}

/* ===== similar ===== */
function renderSimilarChips(){
  similarChips.innerHTML="";
  similarSelected.forEach((s,i)=>{
    const d=document.createElement("div");
    d.className="chip";
    d.textContent=s;
    d.onclick=()=>{similarSelected.splice(i,1);renderSimilarChips();markDirty();};
    similarChips.appendChild(d);
  });
}

similarInput.oninput=()=>{
  const q=similarInput.value.toLowerCase();
  similarList.innerHTML="";
  if(!q){similarList.style.display="none";return;}
  words.map(w=>w.en).filter(e=>e.toLowerCase().includes(q)).forEach(e=>{
    const d=document.createElement("div");
    d.textContent=e;
    d.onclick=()=>{
      if(!similarSelected.includes(e))similarSelected.push(e);
      similarInput.value="";
      similarList.style.display="none";
      renderSimilarChips();markDirty();
    };
    similarList.appendChild(d);
  });
  similarList.style.display="block";
};
sortToggle.onclick = () => {
  sortMode = !sortMode;
  document.body.classList.toggle("sort-mode", sortMode);
  sortToggle.textContent = `排序模式：${sortMode ? "开" : "关"}`;
  renderList();
};


/* ===== classification ===== */
function renderClassChips(){
  classChips.innerHTML="";
  classificationSelected.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="chip";
    d.textContent=c.cn;
    d.title=c.en;
    d.onclick=()=>{classificationSelected.splice(i,1);renderClassChips();markDirty();};
    classChips.appendChild(d);
  });
}

classInput.oninput=()=>{
  const q=classInput.value.toLowerCase();
  classList.innerHTML="";
  if(!q){classList.style.display="none";return;}
  words.forEach(w=>{
    if(w.en.toLowerCase().includes(q)||(w.cn&&w.cn.includes(q))){
      const d=document.createElement("div");
      d.textContent=`${w.cn||"(无中文)"} · ${w.en}`;
      d.onclick=()=>{
        if(!classificationSelected.some(c=>c.en===w.en)){
          classificationSelected.push({en:w.en,cn:w.cn||w.en});
        }
        classInput.value="";
        classList.style.display="none";
        renderClassChips();markDirty();
      };
      classList.appendChild(d);
    }
  });
  classList.style.display="block";
};


/* ===== list ===== */
function renderList(){
  wordList.innerHTML = "";

  words.forEach((w, i) => {
    const row = document.createElement("div");
    row.className = "list-row";

    /* ↑ */
    const up = document.createElement("button");
    up.className = "sort-btn";
    up.textContent = "↑";
    up.disabled = i === 0;
    up.onclick = e => {
      e.stopPropagation();
      moveWord(i, -1);
    };

    /* ↓ */
    const down = document.createElement("button");
    down.className = "sort-btn";
    down.textContent = "↓";
    down.disabled = i === words.length - 1;
    down.onclick = e => {
      e.stopPropagation();
      moveWord(i, 1);
    };

    /* 单词 */
    const b = document.createElement("button");
    b.className = "word-btn";
    b.textContent = w.en;
    b.onclick = () => {
      if (sortMode) return;
      if (isDirty && !confirm("当前词条未保存，是否切换？")) return;
      load(i);
    };
    if (i === currentIndex) b.classList.add("active");

    /* 组合 */
    if (sortMode) {
      row.appendChild(up);
      row.appendChild(down);
    }
    row.appendChild(b);

    wordList.appendChild(row);
  });
}

  wordList.innerHTML="";
  words.forEach((w,i)=>{
    const row = document.createElement("div");
    row.style.display="flex";
    row.style.alignItems="center";
    row.style.gap="4px";
    row.style.margin="0 8px 6px";

    const b = document.createElement("button");
    b.className="word-btn";
    b.textContent=w.en;
    b.style.flex="1";
    if(i===currentIndex) b.classList.add("active");

    b.onclick=()=>{
      if(isDirty && !confirm("当前词条未保存，是否切换？")) return;
      load(i);
    };

    if(sortMode){
      const up=document.createElement("button");
      up.textContent="↑";
      up.disabled=i===0;
      up.onclick=e=>{e.stopPropagation();moveWord(i,-1);};

      const down=document.createElement("button");
      down.textContent="↓";
      down.disabled=i===words.length-1;
      down.onclick=e=>{e.stopPropagation();moveWord(i,1);};

      row.appendChild(up);
      row.appendChild(down);
    }

    row.appendChild(b);
    wordList.appendChild(row);
  });

  wordList.innerHTML="";
  words.forEach((w,i)=>{
const b = document.createElement("button");
b.className = "word-btn";
b.textContent = w.en;


    row.style.display="flex";
    row.style.alignItems="center";
    row.style.gap="4px";
    row.style.margin="0 8px 6px";

    b.style.flex = "1";
    if(i===currentIndex) b.classList.add("active");

    b.onclick = ()=>{
      if(isDirty && !confirm("当前词条未保存，是否切换？")) return;
      load(i);
    };

    const up = document.createElement("button");
    up.textContent="↑";
    up.style.width="28px";

    up.onclick = (e)=>{
      e.stopPropagation();
      moveWord(i,-1);
    };

    const down = document.createElement("button");
    down.textContent="↓";
    down.style.width="28px";

    down.onclick = (e)=>{
      e.stopPropagation();
      moveWord(i,1);
    };
if(i===0) up.disabled = true;
if(i===words.length-1) down.disabled = true;


if(sortMode){
  row.appendChild(up);
  row.appendChild(down);
}
    row.appendChild(b);
    wordList.appendChild(row);
  });
function moveWord(index, direction){
  const newIndex = index + direction;
  if(newIndex < 0 || newIndex >= words.length) return;

  // 交换数组位置
  [words[index], words[newIndex]] = [words[newIndex], words[index]];

  // 修正 currentIndex
  if(currentIndex === index) currentIndex = newIndex;
  else if(currentIndex === newIndex) currentIndex = index;

  renderList();
}


function load(i){
  currentIndex=i;
  const w=words[i];
  en.value=w.en||"";cn.value=w.cn||"";
  enUsage.innerHTML=w.enUsage||"";usage.innerHTML=w.usage||"";
  formula.value=w.formula||"";category.value=w.category||"";
  example.value=w.example||"";updated.value=w.updated||"";
  similarSelected=[...(w.similar||[])];
  classificationSelected=[...(w.classification||[])];
  selectedTags=[...(w.tags||[])];
  renderSimilarChips();renderClassChips();renderTagSelector();
  snapshot=getFormState();isDirty=false;
  title.textContent=w.en;title.classList.remove("dirty");
  document.querySelectorAll("#wordList .word-btn").forEach(b=>b.classList.remove("active","dirty"));
  document.querySelectorAll("#wordList .word-btn")[i]
  ?.classList.add("active");

}

/* ===== actions ===== */
function save(){
  if(currentIndex===null)return alert("未选择词条");
  Object.assign(words[currentIndex],{
    en:en.value,cn:cn.value,
    enUsage:enUsage.innerHTML,
    usage:usage.innerHTML,
    formula:formula.value,
    category:category.value,
    similar:[...similarSelected],
    classification:[...classificationSelected],
    example:example.value,
    tags:[...selectedTags],
    updated:new Date().toISOString().slice(0,10)
  });
  updated.value=words[currentIndex].updated;
  snapshot=getFormState();isDirty=false;
  title.classList.remove("dirty");
  document.querySelectorAll("#wordList .word-btn")[currentIndex].classList.remove("dirty");
  renderList();showToast();
}

function newWord(){
  words.push({en:"NewTerm",cn:"",tags:[],updated:""});
  renderList();load(words.length-1);
}
function remove(){
  if(currentIndex===null)return;
  if(!confirm("确定删除？"))return;
  words.splice(currentIndex,1);
  currentIndex=null;
  renderList();
}
function exportData(){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([`const words=${JSON.stringify(words,null,2)};`]));
  a.download="data.js";a.click();
}

devSearch.oninput=e=>{
  const q=e.target.value.toLowerCase();
document.querySelectorAll("#wordList .word-btn").forEach(b=>{
  b.parentElement.style.display =
    b.textContent.toLowerCase().includes(q) ? "flex" : "none";
});

};

renderList();renderTagSelector();
</script>
</body>
</html>
