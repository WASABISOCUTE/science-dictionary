<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Science Dictionary</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<h1>Science Dictionary</h1>
<input id="search" placeholder="Type English / Chinese / Subject">

<div id="filter">
  <select id="subjectFilter">
    <option value="">All Subject</option>
    <option value="Physics">Physics</option>
    <option value="Math">Math</option>
    <option value="Chemistry">Chemistry</option>
  </select>
  <select id="categoryFilter">
    <option value="">All Category</option>
    <option value="Scalar">Scalar</option>
    <option value="Vector">Vector</option>
    <option value="Function">Function</option>
    <option value="Theorem">Theorem</option>
    <option value="Substance">Substance</option>
  </select>
  <button id="clearFilter">Clear Filter</button>
  <button id="showMarkedBtn">⭐ 显示已标记单词</button>
</div>

<div id="list"></div>

<div id="detail" style="display:none;">
  <button id="backBtn">← Back</button>
  <h2 id="dEn"></h2>
  <p id="dCn"></p>
  <div id="dTags"></div>
  <p><strong>类别:</strong> <span id="dCategory"></span></p>
  <p><strong>中文解释:</strong> <span id="dUsage"></span></p>
  <p><strong>English:</strong> <span id="dEnUsage"></span></p>
  <p><strong>公式:</strong> <span id="dFormula"></span></p>
  <p><strong>示例:</strong> <span id="dExample"></span></p>
  <div id="dSimilar"><strong>相关单词:</strong></div>
  <button id="markDetailBtn">☆ 标记</button>
  <button id="reportBtn">⚠️ 报告错误</button>
  <div id="reportForm" style="display:none;">
    <p>请填写正确资料：</p>
    <textarea id="reportText" placeholder="输入正确的英文/中文/公式/示例等" rows="4"></textarea>
    <button id="submitReport">提交</button>
    <button id="cancelReport">取消</button>
  </div>
</div>

<script src="data.js"></script>
<script>
const input = document.getElementById("search");
const list = document.getElementById("list");
const detail = document.getElementById("detail");
const backBtn = document.getElementById("backBtn");

const dEn = document.getElementById("dEn");
const dCn = document.getElementById("dCn");
const dTags = document.getElementById("dTags");
const dCategory = document.getElementById("dCategory");
const dUsage = document.getElementById("dUsage");
const dEnUsage = document.getElementById("dEnUsage");
const dFormula = document.getElementById("dFormula");
const dExample = document.getElementById("dExample");
const dSimilar = document.getElementById("dSimilar");

const subjectFilter = document.getElementById("subjectFilter");
const categoryFilter = document.getElementById("categoryFilter");
const clearFilter = document.getElementById("clearFilter");
const showMarkedBtn = document.getElementById("showMarkedBtn");
const reportBtn = document.getElementById("reportBtn");
const reportForm = document.getElementById("reportForm");
const reportText = document.getElementById("reportText");
const submitReport = document.getElementById("submitReport");
const cancelReport = document.getElementById("cancelReport");
const markDetailBtn = document.getElementById("markDetailBtn");

let currentWord = null;
let markedWords = JSON.parse(localStorage.getItem("markedWords")||"[]");
let showingMarkedOnly = false;

function updateMarkBtn(btn, wordEn){
  btn.textContent = markedWords.includes(wordEn)?"★":"☆";
}

function initMarkButtons(){
  document.querySelectorAll(".markBtn").forEach(btn=>{
    const wordEn = btn.dataset.en;
    updateMarkBtn(btn, wordEn);
    btn.addEventListener("click", e=>{
      e.stopPropagation();
      if(markedWords.includes(wordEn)){ markedWords=markedWords.filter(w=>w!==wordEn);}
      else{ markedWords.push(wordEn);}
      localStorage.setItem("markedWords",JSON.stringify(markedWords));
      updateMarkBtn(btn, wordEn);
    });
  });
}

function render(items){
  list.innerHTML="";
  items.forEach(w=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h2>${w.en} / ${w.cn}</h2>
      <div class="tags">${(w.tags||[]).map(t=>`<span class="tag ${t}" data-tag="${t}">${t}</span>`).join("")}</div>
      <button class="markBtn" data-en="${w.en}">☆</button>
    `;
    div.addEventListener("click",()=>showDetail(w));
    list.appendChild(div);
  });
  initMarkButtons();
}

function showDetail(word){
  currentWord = word;
  list.style.display="none";
  detail.style.display="block";
  dEn.textContent = word.en;
  dCn.textContent = word.cn;
  dTags.innerHTML = (word.tags||[]).map(t=>`<span class="tag ${t}" data-tag="${t}">${t}</span>`).join("");
  dCategory.textContent = word.category||"";
  dUsage.textContent = word.usage||"";
  dEnUsage.textContent = word.enUsage||"";
  dFormula.innerHTML = word.formula?`\\(${word.formula}\\)`:"无";
  dExample.textContent = word.example||"无";
  dSimilar.innerHTML="<strong>相关单词:</strong> ";
  (word.similar||[]).forEach(sim=>{
    const simWord = words.find(w=>w.en===sim);
    if(simWord){
      const btn = document.createElement("button");
      btn.textContent = simWord.en;
      btn.className="tag";
      btn.addEventListener("click",()=>showDetail(simWord));
      dSimilar.appendChild(btn);
    }
  });
  if((word.similar||[]).length===0) dSimilar.innerHTML+="无";
  updateMarkBtn(markDetailBtn, word.en);
  MathJax.typesetPromise();
  reportForm.style.display="none";
  reportText.value="";
}

backBtn.addEventListener("click",()=>{detail.style.display="none";list.style.display="block";});
input.addEventListener("input",()=>{
  const q=input.value.toLowerCase();
  const result=words.filter(w=>w.en.toLowerCase().includes(q)||w.cn.includes(q)||(w.tags||[]).join("").toLowerCase().includes(q));
  render(result);
});
document.body.addEventListener("click",e=>{
  if(e.target.classList.contains("tag") && e.target.dataset.tag){
    const tag=e.target.dataset.tag;
    const result=words.filter(w=>(w.tags||[]).includes(tag));
    render(result);
    detail.style.display="none";
    list.style.display="block";
  }
});

subjectFilter.addEventListener("change",applyFilters);
categoryFilter.addEventListener("change",applyFilters);
clearFilter.addEventListener("click",()=>{
  subjectFilter.value="";categoryFilter.value="";showingMarkedOnly=false;showMarkedBtn.textContent="⭐ 显示已标记单词";
  render(words);
});

function applyFilters(){
  let filtered=words;
  const subject=subjectFilter.value;
  const category=categoryFilter.value;
  if(subject) filtered=filtered.filter(w=>(w.tags||[]).includes(subject));
  if(category) filtered=filtered.filter(w=>w.category===category);
  if(showingMarkedOnly) filtered=filtered.filter(w=>markedWords.includes(w.en));
  render(filtered);
}

showMarkedBtn.addEventListener("click", ()=>{
  showingMarkedOnly = !showingMarkedOnly;
  if(showingMarkedOnly){
    showMarkedBtn.textContent = "⭐ 显示全部单词";
  } else {
    showMarkedBtn.textContent = "⭐ 显示已标记单词";
  }
  applyFilters();
});

markDetailBtn.addEventListener("click", ()=>{
  if(!currentWord) return;
  const wordEn = currentWord.en;
  if(markedWords.includes(wordEn)){ markedWords = markedWords.filter(w=>w!==wordEn);}
  else{ markedWords.push(wordEn);}
  localStorage.setItem("markedWords",JSON.stringify(markedWords));
  updateMarkBtn(markDetailBtn, wordEn);
});

reportBtn.addEventListener("click",()=>{reportForm.style.display="block";reportText.value="";});
cancelReport.addEventListener("click",()=>{reportForm.style.display="none";reportText.value="";});
submitReport.addEventListener("click",()=>{
  if(currentWord){
    const content = reportText.value.trim();
    if(content){
      const repo = "https://github.com/WASABISOCUTE/science-dictionary/issues/new";
      const title = encodeURIComponent(`Science Dictionary 单词报错: ${currentWord.en}`);
      const body = encodeURIComponent(`错误单词: ${currentWord.en}\n用户提供资料:\n${content}`);
      window.open(`${repo}?title=${title}&body=${body}`,"_blank");
      alert("感谢反馈，已打开 GitHub Issues 提交报告。");
      reportForm.style.display="none";
      reportText.value="";
    } else alert("请填写正确资料。");
  }
});

render(words);
</script>
</body>
</html>
