<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Science Dictionary</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<h1>ğŸ“˜ ç†ç§‘è¯å…¸</h1>
<input id="search" placeholder="è¾“å…¥è‹±æ–‡ / ä¸­æ–‡ / å­¦ç§‘">

<div id="filter">
  <select id="subjectFilter">
    <option value="">å…¨éƒ¨ç§‘ç›®</option>
    <option value="Physics">Physics</option>
    <option value="Math">Math</option>
    <option value="Chemistry">Chemistry</option>
  </select>
  <select id="categoryFilter">
    <option value="">å…¨éƒ¨ç±»åˆ«</option>
    <option value="Scalar">Scalar</option>
    <option value="Vector">Vector</option>
    <option value="Function">Function</option>
    <option value="Theorem">Theorem</option>
    <option value="Substance">Substance</option>
  </select>
  <button id="clearFilter">æ¸…é™¤ç­›é€‰</button>
  <button id="showMarkedBtn">â­ æ˜¾ç¤ºå·²æ ‡è®°å•è¯</button>
</div>

<div id="list"></div>

<div id="detail" style="display:none;">
  <button id="backBtn">â† è¿”å›</button>
  <h2 id="dEn"></h2>
  <p id="dCn"></p>
  <div id="dTags"></div>
  <p><strong>ç±»åˆ«:</strong> <span id="dCategory"></span></p>
  <p><strong>ä¸­æ–‡è§£é‡Š:</strong> <span id="dUsage"></span></p>
  <p><strong>English:</strong> <span id="dEnUsage"></span></p>
  <p><strong>å…¬å¼:</strong> <span id="dFormula"></span></p>
  <p><strong>ç¤ºä¾‹:</strong> <span id="dExample"></span></p>
  <div id="dSimilar"><strong>ç›¸å…³å•è¯:</strong></div>
  <button id="markDetailBtn">â˜† æ ‡è®°</button>
  <button id="reportBtn">âš ï¸ æŠ¥å‘Šé”™è¯¯</button>
  <div id="reportForm" style="display:none;">
    <p>è¯·å¡«å†™æ­£ç¡®èµ„æ–™ï¼š</p>
    <textarea id="reportText" placeholder="è¾“å…¥æ­£ç¡®çš„è‹±æ–‡/ä¸­æ–‡/å…¬å¼/ç¤ºä¾‹ç­‰" rows="4"></textarea>
    <button id="submitReport">æäº¤</button>
    <button id="cancelReport">å–æ¶ˆ</button>
  </div>
</div>

<script src="data.js"></script>
<script>
const input = document.getElementById("search");
const list = document.getElementById("list");
const detail = document.getElementById("detail");
const backBtn = document.getElementById("backBtn");

const dEn = document.getElementById("dEn");
const dCn = document.getElementById("dCn");
const dTags = document.getElementById("dTags");
const dCategory = document.getElementById("dCategory");
const dUsage = document.getElementById("dUsage");
const dEnUsage = document.getElementById("dEnUsage");
const dFormula = document.getElementById("dFormula");
const dExample = document.getElementById("dExample");
const dSimilar = document.getElementById("dSimilar");

const subjectFilter = document.getElementById("subjectFilter");
const categoryFilter = document.getElementById("categoryFilter");
const clearFilter = document.getElementById("clearFilter");
const showMarkedBtn = document.getElementById("showMarkedBtn");
const reportBtn = document.getElementById("reportBtn");
const reportForm = document.getElementById("reportForm");
const reportText = document.getElementById("reportText");
const submitReport = document.getElementById("submitReport");
const cancelReport = document.getElementById("cancelReport");
const markDetailBtn = document.getElementById("markDetailBtn");

let currentWord = null;
let markedWords = JSON.parse(localStorage.getItem("markedWords")||"[]");
let showingMarkedOnly = false;

function updateMarkBtn(btn, wordEn){
  btn.textContent = markedWords.includes(wordEn)?"â˜…":"â˜†";
}

function initMarkButtons(){
  document.querySelectorAll(".markBtn").forEach(btn=>{
    const wordEn = btn.dataset.en;
    updateMarkBtn(btn, wordEn);
    btn.addEventListener("click", e=>{
      e.stopPropagation();
      if(markedWords.includes(wordEn)){ markedWords=markedWords.filter(w=>w!==wordEn);}
      else{ markedWords.push(wordEn);}
      localStorage.setItem("markedWords",JSON.stringify(markedWords));
      updateMarkBtn(btn, wordEn);
    });
  });
}

function render(items){
  list.innerHTML="";
  items.forEach(w=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h2>${w.en} / ${w.cn}</h2>
      <div class="tags">${(w.tags||[]).map(t=>`<span class="tag ${t}" data-tag="${t}">${t}</span>`).join("")}</div>
      <button class="markBtn" data-en="${w.en}">â˜†</button>
    `;
    div.addEventListener("click",()=>showDetail(w));
    list.appendChild(div);
  });
  initMarkButtons();
}

function showDetail(word){
  currentWord = word;
  list.style.display="none";
  detail.style.display="block";
  dEn.textContent = word.en;
  dCn.textContent = word.cn;
  dTags.innerHTML = (word.tags||[]).map(t=>`<span class="tag ${t}" data-tag="${t}">${t}</span>`).join("");
  dCategory.textContent = word.category||"";
  dUsage.textContent = word.usage||"";
  dEnUsage.textContent = word.enUsage||"";
  dFormula.innerHTML = word.formula?`\\(${word.formula}\\)`:"æ— ";
  dExample.textContent = word.example||"æ— ";
  dSimilar.innerHTML="<strong>ç›¸å…³å•è¯:</strong> ";
  (word.similar||[]).forEach(sim=>{
    const simWord = words.find(w=>w.en===sim);
    if(simWord){
      const btn = document.createElement("button");
      btn.textContent = simWord.en;
      btn.className="tag";
      btn.addEventListener("click",()=>showDetail(simWord));
      dSimilar.appendChild(btn);
    }
  });
  if((word.similar||[]).length===0) dSimilar.innerHTML+="æ— ";
  updateMarkBtn(markDetailBtn, word.en);
  MathJax.typesetPromise();
  reportForm.style.display="none";
  reportText.value="";
}

backBtn.addEventListener("click",()=>{detail.style.display="none";list.style.display="block";});
input.addEventListener("input",()=>{
  const q=input.value.toLowerCase();
  const result=words.filter(w=>w.en.toLowerCase().includes(q)||w.cn.includes(q)||(w.tags||[]).join("").toLowerCase().includes(q));
  render(result);
});
document.body.addEventListener("click",e=>{
  if(e.target.classList.contains("tag") && e.target.dataset.tag){
    const tag=e.target.dataset.tag;
    const result=words.filter(w=>(w.tags||[]).includes(tag));
    render(result);
    detail.style.display="none";
    list.style.display="block";
  }
});

subjectFilter.addEventListener("change",applyFilters);
categoryFilter.addEventListener("change",applyFilters);
clearFilter.addEventListener("click",()=>{
  subjectFilter.value="";categoryFilter.value="";showingMarkedOnly=false;showMarkedBtn.textContent="â­ æ˜¾ç¤ºå·²æ ‡è®°å•è¯";
  render(words);
});

function applyFilters(){
  let filtered=words;
  const subject=subjectFilter.value;
  const category=categoryFilter.value;
  if(subject) filtered=filtered.filter(w=>(w.tags||[]).includes(subject));
  if(category) filtered=filtered.filter(w=>w.category===category);
  if(showingMarkedOnly) filtered=filtered.filter(w=>markedWords.includes(w.en));
  render(filtered);
}

showMarkedBtn.addEventListener("click", ()=>{
  showingMarkedOnly = !showingMarkedOnly;
  if(showingMarkedOnly){
    showMarkedBtn.textContent = "â­ æ˜¾ç¤ºå…¨éƒ¨å•è¯";
  } else {
    showMarkedBtn.textContent = "â­ æ˜¾ç¤ºå·²æ ‡è®°å•è¯";
  }
  applyFilters();
});

markDetailBtn.addEventListener("click", ()=>{
  if(!currentWord) return;
  const wordEn = currentWord.en;
  if(markedWords.includes(wordEn)){ markedWords = markedWords.filter(w=>w!==wordEn);}
  else{ markedWords.push(wordEn);}
  localStorage.setItem("markedWords",JSON.stringify(markedWords));
  updateMarkBtn(markDetailBtn, wordEn);
});

reportBtn.addEventListener("click",()=>{reportForm.style.display="block";reportText.value="";});
cancelReport.addEventListener("click",()=>{reportForm.style.display="none";reportText.value="";});
submitReport.addEventListener("click",()=>{
  if(currentWord){
    const content = reportText.value.trim();
    if(content){
      const repo = "https://github.com/WASABISOCUTE/science-dictionary/issues/new";
      const title = encodeURIComponent(`Science Dictionary å•è¯æŠ¥é”™: ${currentWord.en}`);
      const body = encodeURIComponent(`é”™è¯¯å•è¯: ${currentWord.en}\nç”¨æˆ·æä¾›èµ„æ–™:\n${content}`);
      window.open(`${repo}?title=${title}&body=${body}`,"_blank");
      alert("æ„Ÿè°¢åé¦ˆï¼Œå·²æ‰“å¼€ GitHub Issues æäº¤æŠ¥å‘Šã€‚");
      reportForm.style.display="none";
      reportText.value="";
    } else alert("è¯·å¡«å†™æ­£ç¡®èµ„æ–™ã€‚");
  }
});

render(words);
</script>
</body>
</html>
